<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOSC Labour Weekend — Standalone Results App (v2)</title>
  <style>
    :root{
      --bg:#eef3f7; --card:#ffffff; --muted:#f3f6f9; --text:#152235; --text-muted:#6b7280;
      --border:#dde3ea; --accent:#0ea5e9; --accent-strong:#2563eb; --warn:#f59e0b; --danger:#ef4444; --ok:#059669;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
    header{position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 20px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px;width:auto;border-radius:6px;border:1px solid var(--border);background:#fff}
    .brand h1{margin:0;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--text-muted);font-size:13px;margin-top:2px}
    nav{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 0}
    nav button{background:var(--muted);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    nav button.active{outline:2px solid var(--accent);background:#eaf6ff}
    main{padding:20px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 2px 6px rgba(26,46,60,.06)}
    h2{margin:.2rem 0 0.6rem}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    label{font-size:12px;color:var(--text-muted);margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;background:#fff;border:1px solid var(--border);color:var(--text)}
    textarea{min-height:84px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--muted);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#e8f5ff,#dff3ff);border:1px solid var(--accent);color:#0b3860}
    .btn.accent{background:linear-gradient(180deg,#e7ecff,#dee8ff);border:1px solid var(--accent-strong);color:#143a8b}
    .btn.warn{background:#fff8eb;border:1px solid #f3c97a;color:#8a5a06}
    .btn.danger{background:#fff1f1;border:1px solid #f3a6a6;color:#8a1f1f}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#555;font-size:12px}
    .switch{display:inline-flex;gap:8px;align-items:center}
    .switch input{width:auto}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
    thead{background:#f9fafb}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th button{background:none;border:none;color:var(--text);cursor:pointer}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .three{grid-template-columns:repeat(3,1fr)}
    details{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
    summary{cursor:pointer;color:#111}
    .muted{color:var(--text-muted)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#444;font-size:12px}
    .nz-date{font-variant-numeric:tabular-nums}
    .cat-badge{padding:2px 6px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .cat-Adult{background:#e8f0ff;color:#0f2b88}
    .cat-Junior{background:#e8fff0;color:#0f8852}
    .sponsor{color:#0b3860;font-weight:600}
    .footer{color:var(--text-muted);font-size:12px;margin-top:20px}
    .pad-around{padding:6px 10px;border-radius:10px;border:1px dashed var(--border);background:#fff}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    @media(max-width:900px){.col-6,.col-4,.col-3,.col-8{grid-column:span 12} .two,.three{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <img id="brand-logo" alt="WOSC logo" />
        <div>
          <h1>WOSC — Labour Weekend</h1>
          <div class="sub">Registration, Submit Fish, Results & Prizegiving</div>
        </div>
      </div>
      <nav id="tabs"></nav>
    </div>
  </header>

  <main class="wrap">
    <section id="view"></section>
    <div class="footer">Single-file app. Competitors, fish, results & sponsors are stored in Supabase. Prizes/branding are local for now.</div>
  </main>

  <!-- ===================== Supabase ===================== -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://pxkniqhiorgtvcsoocif.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4a25pcWhpb3JndHZjc29vY2lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MzAwMDgsImV4cCI6MjA3NDMwNjAwOH0.x0pH7QevkJ0nZJioqIx2ssqhcTiLlb0h_lgnlKLV330";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- ============ Constants / Local helpers ============= -->
  <script>
    const STORE_KEYS = {
      prizes: "easterfish.prizes.v3",
      branding: "easterfish.branding.v1",
      sponsors: "easterfish.sponsors.v1"
    };

    const DEFAULT_SPECIES = ["Snapper","Kingfish","Kahawai","Trevally","Gurnard","John Dory","Crayfish / Cray (Diver)","Dive Snapper","Yellow Fin Tuna"];
    const DEFAULT_SETTINGS = {
      earlyBirdCutoff: "2025-10-01",
      fees: { Adult:{early:80,standard:100}, Junior:{early:40,standard:50} },
      decimals: 2,
      showTime: true,
      requireTime: false,
      compMode: "weight",
      prizeMode: "combined"
    };

    function loadLocal(k,f){ try{ const r=localStorage.getItem(k); return r?JSON.parse(r):structuredClone(f);}catch{ return structuredClone(f);} }
    function saveLocal(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    const $ = s=>document.querySelector(s);
    function fmt(n,d=2){ return Number(n).toFixed(d); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
    function cssId(name){ return name.toLowerCase().replace(/[^a-z0-9]+/g,"-"); }
    function formatNZ(iso){ if(!iso) return ""; const d=new Date(iso+"T00:00:00"); const dd=String(d.getDate()).padStart(2,"0"); const mm=String(d.getMonth()+1).padStart(2,"0"); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function computeFee(settings, category, paidOn){
      if(!paidOn) return null;
      const cutoff = new Date(settings.earlyBirdCutoff);
      const isEarly = new Date(paidOn) <= cutoff;
      const fees = settings.fees[category];
      return isEarly ? fees.early : fees.standard;
    }
  </script>

  <!-- ============== Supabase data helpers =============== -->
  <script>
    /** SETTINGS **/
    async function sbFetchSettings(){
      const { data, error } = await sb.from('settings').select('*').limit(1).maybeSingle();
      if(error) { console.warn(error); return null; }
      if(!data){
        return {...DEFAULT_SETTINGS};
      }
      return {
        earlyBirdCutoff: data.early_bird_cutoff || DEFAULT_SETTINGS.earlyBirdCutoff,
        fees: DEFAULT_SETTINGS.fees,
        decimals: DEFAULT_SETTINGS.decimals,
        showTime: data.time_visible ?? DEFAULT_SETTINGS.showTime,
        requireTime: data.time_required ?? DEFAULT_SETTINGS.requireTime,
        compMode: data.comp_mode || DEFAULT_SETTINGS.compMode,
        prizeMode: data.prize_mode || DEFAULT_SETTINGS.prizeMode
      };
    }

    /** SPECIES **/
    async function sbListSpecies(){
      const { data, error } = await sb.from('species').select('id,name,is_measure').order('name');
      if(error){ console.warn(error); return DEFAULT_SPECIES.map((n,i)=>({id:i+1,name:n,is_measure:false})); }
      if(!data || !data.length){ return DEFAULT_SPECIES.map((n,i)=>({id:i+1,name:n,is_measure:false})); }
      return data;
    }

    /** COMPETITORS **/
    async function sbAddCompetitor(payload){
      const { data, error } = await sb.from('competitor').insert(payload).select().single();
      if(error) throw error;
      return data;
    }
    async function sbListCompetitors(){
      const { data, error } = await sb.from('competitor')
        .select('id, full_name, category, boat, email, phone, paid_on, created_at')
        .order('created_at', { ascending: false });
      if(error) throw error;
      return data;
    }
    async function sbDeleteCompetitors(ids){
      const { error } = await sb.from('competitor').delete().in('id', ids);
      if(error) throw error;
    }

    /** FISH **/
    async function sbAddFish(payload){
      const { data, error } = await sb.from('fish').insert(payload).select().single();
      if(error) throw error;
      return data;
    }
    async function sbListFishJoined(){
      const { data, error } = await sb.from('fish').select(`
        id, weight_kg, length_cm, time_caught, created_at,
        competitor:competitor_id(id, full_name, category, boat, paid_on),
        species:species_id(id, name)
      `).order('created_at', { ascending: false });
      if(error) throw error;
      return data;
    }
    async function sbDeleteFish(ids){
      const { error } = await sb.from('fish').delete().in('id', ids);
      if(error) throw error;
    }

    /** SPONSORS (master list) **/
    async function sbListSponsors(){
      const { data, error } = await sb.from('sponsors').select('id, name').order('name');
      if (error) throw error;
      return data || [];
    }
    async function sbAddSponsor(name){
      const { data, error } = await sb.from('sponsors')
        .insert({ name })
        .select('id, name')
        .single();
      if (error) throw error;
      return data;
    }
    async function sbDeleteSponsor(id){
      const { error } = await sb.from('sponsors').delete().eq('id', id);
      if (error) throw error;
    }

    /** SPONSOR CONFIG + ASSIGNMENTS **/
    async function sbGetDefaultSponsorGroup(){
      const { data, error } = await sb.from('sponsor_group')
        .select('*').eq('is_default', true).limit(1).maybeSingle();
      if (error) throw error;
      return data;
    }
    async function sbListSponsorLevels(groupId){
      const { data, error } = await sb.from('sponsor_level')
        .select('id, key, label, sort_order, readout, active')
        .eq('group_id', groupId).eq('active', true)
        .order('sort_order');
      if (error) throw error;
      return data || [];
    }
    async function sbGetCurrentCompetition(){
      const { data, error } = await sb.from('competition')
        .select('id, name, starts_at, ends_at, created_at')
        .order('starts_at', { ascending:false })
        .order('created_at', { ascending:false })
        .limit(1).maybeSingle();
      if (error) throw error;
      return data;
    }
    async function sbEnsureSponsorByName(name){
      const { data, error } = await sb.from('sponsors')
        .upsert({ name }, { onConflict: 'name' })
        .select('id, name').maybeSingle();
      if (error) throw error;
      return data;
    }
    async function sbListCompetitionSponsors(compId){
      const { data, error } = await sb.from('competition_sponsor')
        .select(`
          id, display_order, blurb,
          sponsor:sponsor_id ( id, name ),
          level:level_id ( id, key, label, sort_order )
        `)
        .eq('competition_id', compId);
      if (error) throw error;
      return (data||[]).sort((a,b)=>{
        const la=(a.level?.sort_order??999), lb=(b.level?.sort_order??999);
        if (la!==lb) return la-lb;
        const da=(a.display_order??999), db=(b.display_order??999);
        if (da!==db) return da-db;
        return (a.sponsor?.name||'').localeCompare(b.sponsor?.name||'');
      });
    }
    async function sbAddCompetitionSponsor({ competition_id, sponsor_name, level_id, display_order=null, blurb=null }){
      const sponsor = await sbEnsureSponsorByName(sponsor_name);
      const payload = { competition_id, sponsor_id: sponsor.id, level_id, display_order, blurb };
      const { data, error } = await sb.from('competition_sponsor')
        .insert(payload).select(`
          id, display_order, blurb,
          sponsor:sponsor_id ( id, name ),
          level:level_id ( id, key, label, sort_order )
        `).single();
      if (error) throw error;
      return data;
    }
    async function sbDeleteCompetitionSponsor(id){
      const { error } = await sb.from('competition_sponsor').delete().eq('id', id);
      if (error) throw error;
    }
  </script>

  <!-- ================= Branding init ==================== -->
  <script>
    (function initBranding(){
      const b = loadLocal(STORE_KEYS.branding, {logoDataUrl:null});
      const img = $("#brand-logo");
      if(b.logoDataUrl){ img.src = b.logoDataUrl; }
      else{
        const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='180' height='40'><rect width='180' height='40' fill='white' stroke='#dde3ea'/><text x='10' y='26' font-size='18' font-family='system-ui' fill='#2563eb'>WOSC</text></svg>`);
        img.src = "data:image/svg+xml;charset=utf-8,"+svg;
      }
    })();
  </script>

  <!-- ================= Router / Nav ===================== -->
  <script>
    const routes = [
      { id:"register", label:"Register" },
      { id:"submit", label:"Submit Fish" },
      { id:"results", label:"Results" },
      { id:"prizes", label:"Prizes" },
      { id:"prizegiving", label:"Prize Giving" },
      { id:"admin", label:"Admin" },
      { id:"data", label:"Import/Export" }
    ];
    function renderTabs(active="register"){
      const nav=$("#tabs"); nav.innerHTML="";
      routes.forEach(r=>{ const b=document.createElement("button"); b.textContent=r.label; b.className=(r.id===active?"active ":""); b.onclick=()=>navigate(r.id); nav.appendChild(b); });
    }
    function navigate(id){ history.replaceState({}, "", "#" + id); renderTabs(id); renderView(id); }
  </script>

  <!-- ============== Global state / boot ================= -->
  <script>
    let G_SETTINGS = structuredClone(DEFAULT_SETTINGS);
    let G_SPECIES = [];
    let G_SPECIES_BY_NAME = new Map();
    let G_COMPETITORS = [];
    let G_FISH = [];
    let G_SPONSORS = [];
    let G_COMPETITION = null;
    let G_SPONSOR_GROUP = null;
    let G_SPONSOR_LEVELS = [];
    let G_COMP_SPONSORS = [];

    async function hydrateFromDB(){
      const s = await sbFetchSettings();
      if(s) G_SETTINGS = s;

      G_SPECIES = await sbListSpecies();
      G_SPECIES_BY_NAME.clear();
      G_SPECIES.forEach(x => G_SPECIES_BY_NAME.set(x.name, x.id));

      G_COMPETITORS = await sbListCompetitors();
      G_FISH = await sbListFishJoined();

      G_SPONSORS = await sbListSponsors();
      G_COMPETITION   = await sbGetCurrentCompetition();
      G_SPONSOR_GROUP = await sbGetDefaultSponsorGroup();
      G_SPONSOR_LEVELS = G_SPONSOR_GROUP ? await sbListSponsorLevels(G_SPONSOR_GROUP.id) : [];
      G_COMP_SPONSORS = G_COMPETITION ? await sbListCompetitionSponsors(G_COMPETITION.id) : [];
    }
  </script>

  <!-- ================== REGISTER ======================== -->
  <script>
    async function renderRegister(root){
      const settings = G_SETTINGS;
      root.innerHTML = `
        <section class="card">
          <h2>Competition Registration</h2>
          <div class="row">
            <div class="col-6"><label>Full Name *</label><input id="r-name" placeholder="First Last" required/></div>
            <div class="col-3"><label>Category *</label><select id="r-cat"><option>Adult</option><option>Junior</option></select></div>
            <div class="col-3">
              <label>Payment Date *</label>
              <input id="r-paydate" type="date" value="${todayISO()}"/>
            </div>
            <div class="col-6"><label>Email</label><input id="r-email" type="email" placeholder="name@example.com"/></div>
            <div class="col-3"><label>Phone</label><input id="r-phone" placeholder="+64 ..."/></div>
            <div class="col-3"><label>Boat / Team</label><input id="r-boat" placeholder="Boat or Team name"/></div>
            <div class="col-12"><label>Notes (local only)</label><textarea id="r-notes" placeholder="Anything we should know... (not stored in DB)"></textarea></div>
          </div>
          <div class="actions" style="display:flex;flex-wrap:wrap;align-items:center;gap:8px 12px;margin-top:6px">
            <span class="pill">Fee: <strong id="r-fee" style="margin-left:6px">$0</strong></span>
            <div style="flex:1 1 auto"></div>
            <button class="btn primary" id="r-save">Register Competitor</button>
            <button class="btn accent" id="r-save-another">Save & Register Another (same boat)</button>
            <button class="btn" id="r-clear">Clear</button>
            <div id="r-fee-rule" style="flex:1 0 100%;order:2;margin-top:6px;line-height:1.3"></div>
          </div>
        </section>

        <section class="card">
          <h3>Registered Competitors</h3>
          <div class="actions">
            <input id="rc-search" placeholder="Search by name / email / boat..." />
            <button class="btn" id="rc-sort">Sort A → Z</button>
            <button class="btn danger" id="rc-del">Delete Selected</button>
          </div>
          <div style="overflow:auto;margin-top:10px">
            <table id="rc-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="rc-all"/></th>
                  <th>Name</th><th>Category</th><th>Email</th><th>Phone</th>
                  <th>Boat/Team</th><th>Payment Date</th><th>Fee</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      `;

      function calcFee(){
        const cat = $("#r-cat").value;
        const pay = $("#r-paydate").value || todayISO();
        const fee = computeFee(settings, cat, pay);
        $("#r-fee").textContent = fee!=null ? `$${fmt(fee,0)}` : "$0";
        $("#r-fee-rule").innerHTML =
          `Early-bird cutoff: <span class="badge">${formatNZ(settings.earlyBirdCutoff)}</span> — ` +
          `Adult $${settings.fees.Adult.early} → $${settings.fees.Adult.standard} after; ` +
          `Junior $${settings.fees.Junior.early} → $${settings.fees.Junior.standard}.`;
      }
      $("#r-cat").onchange = calcFee; $("#r-paydate").onchange = calcFee; calcFee();
      $("#r-clear").onclick = () => renderRegister(root);

      async function saveCompetitor(keepBoat){
        const name = $("#r-name").value.trim();
        const pay  = $("#r-paydate").value;
        if(!name){ alert("Full Name is required"); return; }
        if(!pay){  alert("Payment Date is required"); return; }

        const cat   = $("#r-cat").value;
        const email = $("#r-email").value.trim() || null;
        const phone = $("#r-phone").value.trim() || null;
        const boat  = $("#r-boat").value.trim() || null;

        await sbAddCompetitor({
          full_name: name,
          category: cat.toLowerCase(),
          boat, email, phone,
          paid_on: pay
        });

        G_COMPETITORS = await sbListCompetitors();
        alert("Registered.");

        if(keepBoat){
          const keep = boat || "";
          await renderRegister(root);
          $("#r-boat").value = keep;
        }else{
          await renderRegister(root);
        }
      }

      $("#r-save").onclick = () => saveCompetitor(false);
      $("#r-save-another").onclick = () => saveCompetitor(true);

      const tbody=$("#rc-table tbody"); const all=$("#rc-all"); let selected=new Set(); let rows=[...G_COMPETITORS];
      function paint(){
        const q=($("#rc-search").value||"").toLowerCase();
        const view=rows.filter(r => !q || [r.full_name,r.email,r.boat].join(" ").toLowerCase().includes(q));
        tbody.innerHTML="";
        view.forEach(r=>{
          const dispCat = r.category === 'adult' ? 'Adult' : 'Junior';
          const fee = computeFee(settings, dispCat, r.paid_on);
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?"checked":""}></td>
            <td>${escapeHtml(r.full_name)}</td><td>${dispCat}</td>
            <td>${escapeHtml(r.email||"")}</td><td>${escapeHtml(r.phone||"")}</td>
            <td>${escapeHtml(r.boat||"")}</td><td class="nz-date">${formatNZ(r.paid_on)}</td>
            <td>${fee!=null?("$"+fmt(fee,0)):""}</td>`;
          tbody.appendChild(tr);
        });
      }
      $("#rc-search").oninput=paint; $("#rc-sort").onclick=()=>{ rows.sort((a,b)=>a.full_name.localeCompare(b.full_name)); paint(); };
      all.onchange=(e)=>{ selected=new Set(); tbody.querySelectorAll("input[type=checkbox]").forEach(cb=>{ cb.checked=e.target.checked; if(cb.checked) selected.add(cb.dataset.id); }); };
      tbody.addEventListener("change",(e)=>{ if(e.target.matches("input[type=checkbox]")){ const id=e.target.dataset.id; if(e.target.checked) selected.add(id); else selected.delete(id);} });

      $("#rc-del").onclick=async()=>{ 
        if(selected.size===0){ alert("Select at least one"); return; } 
        if(!confirm("Delete selected competitors? This will also remove their fish.")) return;
        const ids=[...selected];
        await sbDeleteCompetitors(ids);
        G_COMPETITORS = await sbListCompetitors();
        rows = [...G_COMPETITORS]; selected.clear(); all.checked=false; paint();
      };

      paint();
    }
  </script>

  <!-- ================== SUBMIT FISH ===================== -->
  <script>
    async function renderSubmit(root){
      const settings=G_SETTINGS;
      const species=G_SPECIES;
      const competitors=G_COMPETITORS;

      root.innerHTML = `
        <section class="card">
          <h2>Submit a Catch</h2>
          <div class="row">
            <div class="col-6">
              <label>Search competitor (name or boat)</label>
              <input id="f-search" list="comp-list" placeholder="Type to filter by name or boat"/>
              <datalist id="comp-list"></datalist>
              <div class="sub">Or pick from dropdown below.</div>
            </div>
            <div class="col-6">
              <label>Competitor</label>
              <select id="f-competitor">
                <option value="">— Select registered competitor —</option>
                ${competitors.map(c=>`<option value="${c.id}">${escapeHtml(c.full_name)} (${c.category==='adult'?'Adult':'Junior'}) — ${escapeHtml(c.boat||"")}</option>`).join("")}
              </select>
            </div>

            ${settings.compMode==="measure" ? `
              <div class="col-3"><label>Length (cm) <span class="muted">*</span></label><input id="f-length" type="number" step="0.1" placeholder="e.g., 55.2" /></div>
              <div class="col-3"><label>Weight (kg) <span class="muted">(optional)</span></label><input id="f-weight" type="number" step="0.001" placeholder="e.g., 3.45" /></div>
            ` : `
              <div class="col-3"><label>Weight (kg) <span class="muted">*</span></label><input id="f-weight" type="number" step="0.001" placeholder="e.g., 3.45" /></div>
              <div class="col-3"><label>Length (cm) <span class="muted">(optional)</span></label><input id="f-length" type="number" step="0.1" placeholder="e.g., 55.2" /></div>
            `}
            <div class="col-3"><label>Species</label>
              <select id="f-species">
                ${species.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("")}
              </select>
            </div>
            <div class="col-3 ${settings.showTime?'':'muted'}"><label>Time Caught ${settings.requireTime?'<span class="muted">*</span>':''}</label><input id="f-time" type="time" ${settings.showTime?'':'disabled'} value="${new Date().toTimeString().slice(0,5)}"/></div>
            <div class="col-3"><label>Date Caught</label><input id="f-date" type="date" value="${todayISO()}"/></div>
            <div class="col-3"><label>Location (local only)</label><input id="f-loc" placeholder="e.g., Gulf Harbour" /></div>
            <div class="col-12"><label>Notes (local only)</label><textarea id="f-notes" placeholder="Anything worth noting..."></textarea></div>
          </div>
          <div class="actions">
            <label class="switch"><input type="checkbox" id="keep-after"/> Keep competitor after save</label>
            <button class="btn primary" id="btn-save">Save Catch</button>
            <button class="btn accent" id="btn-save-another">Save & Add another</button>
            <button class="btn" id="btn-clear">Clear Form</button>
          </div>
        </section>
      `;

      const dl=$("#comp-list");
      const input=$("#f-search");
      function refreshList(){
        const q=(input.value||"").toLowerCase();
        dl.innerHTML="";
        competitors.filter(c => !q || [c.full_name,c.boat].join(" ").toLowerCase().includes(q))
                   .slice(0,50).forEach(c=>{
                     const opt=document.createElement("option");
                     opt.value=`${c.full_name} (${c.category==='adult'?'Adult':'Junior'}) — ${c.boat||''}`;
                     opt.setAttribute("data-id", c.id);
                     dl.appendChild(opt);
                   });
      }
      input.oninput = ()=>{
        refreshList();
        const match = [...dl.options].find(o=>o.value===input.value);
        if(match){ $("#f-competitor").value = match.getAttribute("data-id"); }
      };
      refreshList();
      $("#btn-clear").onclick = ()=> renderSubmit(root);

      async function saveCatch(stay){
        const compId=$("#f-competitor").value;
        if(!compId){ alert("Please select a registered competitor"); return; }
        const lengthVal=$("#f-length").value ? parseFloat($("#f-length").value) : null;
        const weightVal=$("#f-weight").value ? parseFloat($("#f-weight").value) : null;

        if(settings.compMode==="measure"){
          if(lengthVal==null || lengthVal<=0){ alert("Length is required"); return; }
        }else{
          if(weightVal==null || weightVal<=0){ alert("Weight is required"); return; }
        }
        if(settings.showTime && settings.requireTime && !$("#f-time").value){ alert("Time is required"); return; }

        const speciesId = parseInt($("#f-species").value,10);
        const dateCaught=$("#f-date").value;
        const timeCaught=$("#f-time").value;
        const timeISO = (dateCaught ? dateCaught : todayISO()) + "T" + (timeCaught || "00:00");

        await sbAddFish({
          competitor_id: compId,
          species_id: speciesId,
          weight_kg: weightVal,
          length_cm: lengthVal,
          time_caught: timeISO
        });

        G_FISH = await sbListFishJoined();

        if(stay){
          const keepCompetitor=$("#keep-after").checked ? compId : "";
          alert("Catch saved");
          await renderSubmit(root);
          if(keepCompetitor){ $("#f-competitor").value = keepCompetitor; }
          $("#f-search").focus();
        }else{
          alert("Catch saved");
          navigate("results");
        }
      }
      $("#btn-save").onclick = ()=> saveCatch(false);
      $("#btn-save-another").onclick = ()=> saveCatch(true);
    }
  </script>

  <!-- ======== Sponsor select helper for Prizes ========= -->
  <script>
    // Build a select of sponsors grouped by level, with an optional custom text input.
    function sponsorSelectHTML(selectedId=null, customText=""){
      // Group competition sponsors by level label
      const groups = new Map();
      (G_COMP_SPONSORS || []).forEach(r=>{
        const lvl = r.level?.label || "Sponsors";
        if(!groups.has(lvl)) groups.set(lvl, []);
        const sid = r.sponsor?.id, sname = r.sponsor?.name;
        if(sid && sname) groups.get(lvl).push({ id: sid, name: sname });
      });

      // Build options
      let opts = `<option value="">— none —</option>`;
      for(const [label, list] of groups){
        opts += `<optgroup label="${escapeHtml(label)}">` +
          list.map(s => `<option value="${s.id}" ${selectedId===s.id?'selected':''}>${escapeHtml(s.name)}</option>`).join("") +
          `</optgroup>`;
      }

      const hideOther = selectedId ? 'style="display:none"' : '';
      return `
        <div class="flex" style="gap:6px;align-items:center">
          <select class="pz-sel">${opts}</select>
          <input class="pz-sponsor-other" placeholder="Sponsor name" value="${escapeHtml(customText||"")}" ${hideOther} />
        </div>
      `;
    }
  </script>

  <!-- =================== PRIZES (local) ================= -->
  <script>
    function renderPrizes(root){
      const settings=G_SETTINGS;
      const prizes=loadLocal(STORE_KEYS.prizes, {}); 
      const species=G_SPECIES.map(s=>s.name);
      for(const s of species){
        if(prizes[s] && !("combined" in prizes[s]) && !("adult" in prizes[s])) prizes[s] = { combined: prizes[s] };
        if(!prizes[s]) prizes[s] = {};
      }
      saveLocal(STORE_KEYS.prizes, prizes);

      root.innerHTML = `
<section class="card">
  <h2>Prize Setup <span class="badge">Local for now</span></h2>
  <p class="sub">Admin note: This screen currently saves prizes locally. Next stage: map to Supabase <code>prize</code> table.</p>
  <div class="prize-mode" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:4px">
    <span style="min-width:56px">Mode:</span>
    <label class="switch" style="display:flex;align-items:center;gap:6px;margin:0">
      <input type="radio" name="pmode" value="combined" ${settings.prizeMode==="combined"?"checked":""}/> <span>Combined</span>
    </label>
    <label class="switch" style="display:flex;align-items:center;gap:6px;margin:0">
      <input type="radio" name="pmode" value="split" ${settings.prizeMode==="split"?"checked":""}/> <span>Split: Adult & Junior</span>
    </label>
    <div style="flex:1 1 auto"></div>
    <button class="btn" id="save-mode">Save Mode</button>
  </div>
  <p class="sub">Per-prize sponsor will display in Prize Giving.</p>
  <div class="grid">
    ${species.map(s => `
      <details open>
        <summary><strong>${s}</strong> <span class="muted">— ${countPrizesFor(prizes[s], settings.prizeMode)} prize(s)</span></summary>
        <div style="margin:10px 0">
          ${settings.prizeMode==="combined" ? prizeTableHTML(s, "combined", prizes[s]?.combined||{}) :
            `<h4>Adult</h4>${prizeTableHTML(s,"adult",prizes[s]?.adult||{})}
             <h4>Junior</h4>${prizeTableHTML(s,"junior",prizes[s]?.junior||{})}` }
        </div>
      </details>
    `).join("")}
  </div>
  <div class="actions" style="margin-top:10px">
    <button class="btn" id="save-all">Save All</button>
  </div>
</section>
      `;

      $("#save-mode").onclick=()=>{
        const v=[...document.querySelectorAll('input[name=pmode]')].find(x=>x.checked).value;
        G_SETTINGS.prizeMode=v; alert("Prize mode saved (local).");
        renderPrizes(root);
      };

      // Attach live auto-save hooks
      species.forEach(sp => {
        const sec  = document.getElementById("area-"+cssId(sp)+"-combined");
        const secA = document.getElementById("area-"+cssId(sp)+"-adult");
        const secJ = document.getElementById("area-"+cssId(sp)+"-junior");

        function persistFromRow(tr, key){
          const place=parseInt(tr.querySelector(".pz-place").value||"0");
          const desc=tr.querySelector(".pz-desc").value.trim();
          const valRaw=tr.querySelector(".pz-val").value;
          const value=valRaw===""?null:parseFloat(valRaw);

          const sel = tr.querySelector(".pz-sel");
          const other = tr.querySelector(".pz-sponsor-other");
          const sponsor_id = sel?.value || null;
          if(other){ other.style.display = sponsor_id ? "none" : ""; }
          const sponsor = sponsor_id ? null : (other?.value.trim() || null);

          const P=loadLocal(STORE_KEYS.prizes, {}); if(!P[sp]) P[sp]={};
          if(!P[sp][key]) P[sp][key]={};
          if(place>0 && (desc || sponsor || sponsor_id || value!=null)){
            P[sp][key][place] = { desc, value, sponsor_id, sponsor };
          }
          saveLocal(STORE_KEYS.prizes,P);
        }

        function hook(area, key){
          if(!area) return;
          area.addEventListener("input", (e)=>{ const tr=e.target.closest("tr"); if(tr) persistFromRow(tr,key); });
          area.addEventListener("change",(e)=>{ const tr=e.target.closest("tr"); if(tr) persistFromRow(tr,key); });
        }
        hook(sec,"combined"); hook(secA,"adult"); hook(secJ,"junior");
      });

      // Save All button
      $("#save-all").onclick=()=>{
        const P=loadLocal(STORE_KEYS.prizes, {});
        species.forEach(sp=>{
          function capture(key){
            const area=document.querySelector(`#area-${cssId(sp)}-${key}`); if(!area) return;
            const rows=area.querySelectorAll("tbody tr"); const map={};
            rows.forEach(r=>{
              const place=parseInt(r.querySelector(".pz-place").value||"0");
              const desc=r.querySelector(".pz-desc").value.trim();
              const valRaw=r.querySelector(".pz-val").value; 
              const value=valRaw===""?null:parseFloat(valRaw);
              const sel = r.querySelector(".pz-sel");
              const other = r.querySelector(".pz-sponsor-other");
              const sponsor_id = sel?.value || null;
              const sponsor = sponsor_id ? null : (other?.value.trim() || null);
              if(place>0 && (desc || sponsor || sponsor_id || value!=null))
                map[place] = { desc, value, sponsor_id, sponsor };
            });
            if(!P[sp]) P[sp]={};
            if(Object.keys(map).length>0) P[sp][key]=map; else delete P[sp][key];
          }
          if(G_SETTINGS.prizeMode==="combined"){ capture("combined"); }
          else{ capture("adult"); capture("junior"); }
        });
        saveLocal(STORE_KEYS.prizes, P); alert("Prizes saved (local).");
        renderPrizes(root);
      };

      function countPrizesFor(node, mode){
        if(!node) return 0;
        if(mode==="combined") return node.combined?Object.keys(node.combined).length:0;
        return (node.adult?Object.keys(node.adult).length:0) + (node.junior?Object.keys(node.junior).length:0);
      }

      function prizeTableHTML(speciesName, key, list){
        const rows = Object.keys(list).map(k=>parseInt(k)).sort((a,b)=>a-b).map(k=>{
          const item = list[k] || {};
          const sponsorCell = sponsorSelectHTML(
            item.sponsor_id || null,
            item.sponsor || item.sponsor_name || ""
          );
          return `<tr data-place="${k}">
            <td><input value="${k}" class="pz-place" type="number" min="1" step="1" /></td>
            <td><input value="${escapeHtml(item.desc||"")}" class="pz-desc" placeholder="e.g., $200 voucher" /></td>
            <td><input value="${item.value??""}" class="pz-val" type="number" step="0.01" placeholder="e.g., 200" /></td>
            <td>${sponsorCell}</td>
            <td><button class="btn danger" onclick="removePrize('${encodeURIComponent(speciesName)}','${key}', ${k})">Remove</button></td>
          </tr>`;
        }).join("");
        return `
          <div id="area-${cssId(speciesName)}-${key}">
            <table>
              <thead><tr><th>Place</th><th>Prize (description)</th><th>Value</th><th>Sponsor</th><th></th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
            <div class="actions" style="margin-top:10px">
              <button class="btn accent" onclick="addPrize('${encodeURIComponent(speciesName)}','${key}')">Add Prize</button>
            </div>
          </div>
        `;
      }

      // Row add/remove
      window.addPrize = (spEnc,key)=>{
        const sp=decodeURIComponent(spEnc);
        const P=loadLocal(STORE_KEYS.prizes, {}); if(!P[sp]) P[sp]={}; if(!P[sp][key]) P[sp][key]={};
        const next=(Object.keys(P[sp][key]).map(n=>parseInt(n)).reduce((a,b)=>Math.max(a,b),0) || 0) + 1;
        P[sp][key][next]={desc:"",value:null,sponsor_id:null,sponsor:null};
        saveLocal(STORE_KEYS.prizes,P);
        const area=document.querySelector(`#area-${cssId(sp)}-${key} tbody`);
        if(area){
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td><input value="${next}" class="pz-place" type="number" min="1" step="1" /></td>
            <td><input value="" class="pz-desc" placeholder="e.g., $200 voucher" /></td>
            <td><input value="" class="pz-val" type="number" step="0.01" placeholder="e.g., 200" /></td>
            <td>${sponsorSelectHTML(null, "")}</td>
            <td><button class="btn danger" onclick="removePrize('${spEnc}','${key}', ${next})">Remove</button></td>`;
          area.appendChild(tr);
        }
      };
      window.removePrize = (spEnc,key,place)=>{
        const sp=decodeURIComponent(spEnc);
        const P=loadLocal(STORE_KEYS.prizes, {}); if(!P[sp]||!P[sp][key]) return; delete P[sp][key][place]; saveLocal(STORE_KEYS.prizes,P);
        const area=document.querySelector(`#area-${cssId(sp)}-${key} tbody`);
        if(area){ const r=[...area.querySelectorAll("tr")].find(x=>parseInt(x.querySelector(".pz-place").value||"0")===place); if(r) r.remove(); }
      };
    }
  </script>

  <!-- ================== PRIZE GIVING ==================== -->
  <script>
    function renderPrizeGiving(root){
      const settings=G_SETTINGS;
      const entries = G_FISH.map(f => ({
        id: f.id,
        name: f.competitor?.full_name || "",
        category: (f.competitor?.category==='adult'?'Adult':'Junior'),
        species: f.species?.name || "",
        weight: f.weight_kg,
        length: f.length_cm,
        createdAt: f.created_at
      }));

      const P=loadLocal(STORE_KEYS.prizes, {});
      const speciesNames = G_SPECIES.map(s=>s.name);

      function parseWeighIn(ts){
        if (!ts) return Number.POSITIVE_INFINITY;
        const n = Date.parse(String(ts)); return Number.isNaN(n) ? Number.POSITIVE_INFINITY : n;
      }
      function rankFor(arr){
        const s = settings;
        return arr.slice().sort((a,b)=>{
          const pa = s.compMode==="measure" ? (a.length||0) : (a.weight||0);
          const pb = s.compMode==="measure" ? (b.length||0) : (b.weight||0);
          if (pb !== pa) return pb - pa;
          const ta = parseWeighIn(a.createdAt);
          const tb = parseWeighIn(b.createdAt);
          return ta - tb;
        });
      }

      root.innerHTML = `
        <section class="card">
          <h2>Prize Giving</h2>
          <p class="sub">Mode: <strong>${settings.prizeMode==="combined"?"Combined":"Split (Adult & Junior)"}</strong> — shown in reverse order for announcing (3rd → 1st).</p>
          ${speciesNames.map(s=>{
            const all = entries.filter(e=>e.species===s);
            const node=P[s]||{};
            if(settings.prizeMode==="combined"){
              const pz=node.combined||{};
              const places=Object.keys(pz).map(n=>parseInt(n)).sort((a,b)=>b-a);
              if(places.length===0) return `<section class="card"><h3>${s}</h3><p class="muted">No prizes configured.</p></section>`;
              const ranked=rankFor([...all]).slice(0,Math.max(...places));
              return sectionHTML(s,"Combined",places,ranked,pz);
            }else{
              const pzA=node.adult||{}; const pzJ=node.junior||{};
              const placesA=Object.keys(pzA).map(n=>parseInt(n)).sort((a,b)=>b-a);
              const placesJ=Object.keys(pzJ).map(n=>parseInt(n)).sort((a,b)=>b-a);
              const rankedA=rankFor(all.filter(e=>e.category==="Adult")).slice(0,Math.max(0,...placesA));
              const rankedJ=rankFor(all.filter(e=>e.category==="Junior")).slice(0,Math.max(0,...placesJ));
              return `
                <section class="card"><h3>${s} — Adult</h3>${placesA.length?tableHTML(placesA, rankedA, pzA):'<p class="muted">No Adult prizes.</p>'}</section>
                <section class="card"><h3>${s} — Junior</h3>${placesJ.length?tableHTML(placesJ, rankedJ, pzJ):'<p class="muted">No Junior prizes.</p>'}</section>
              `;
            }
          }).join("")}
          ${overallSponsorsHTML()}
        </section>
      `;

      function overallSponsorsHTML(){
        if (!G_SPONSORS.length) return "";
        return `
          <section class="card">
            <h3>Thanks to our Sponsors</h3>
            <div class="flex">
              ${G_SPONSORS.map(s => `<span class="badge">${escapeHtml(s.name)}</span>`).join(" ")}
            </div>
          </section>
        `;
      }

      function sectionHTML(speciesName, label, places, ranked, prizeMap){
        return `
          <section class="card">
            <h3>${speciesName} — ${label}</h3>
            ${tableHTML(places, ranked, prizeMap, true)}
          </section>
        `;
      }

      function tableHTML(places, ranked, pz, showCat=false){
        return `
          <table>
            <thead><tr><th>Place</th><th>Competitor</th>${showCat?'<th>Category</th>':''}<th>${settings.compMode==="measure"?'Length (cm)':'Weight (kg)'}</th><th>Prize</th><th>Sponsor</th></tr></thead>
            <tbody>
              ${places.map((place)=>{
                const c = ranked[place - 1];
                if(!c) return `<tr><td>${place}</td><td colspan="${showCat?4:3}" class="muted">— no qualified entry —</td></tr>`;
                const prize=pz[place]||{};
                const catBadge=`<span class="cat-badge cat-${c.category}">${c.category}</span>`;
                const metric = settings.compMode==="measure" ? (c.length!=null?fmt(c.length,1):"") : (c.weight!=null?fmt(c.weight,settings.decimals):"");
                const juniorBeatingAdult = (c.category==="Junior" && showCat);

                // Resolve sponsor label from sponsor_id or fallback to text
                const sponsorLabel = (() => {
                  if (prize.sponsor_id) {
                    const byComp = (G_COMP_SPONSORS||[]).find(r => r.sponsor?.id === prize.sponsor_id)?.sponsor?.name;
                    if (byComp) return byComp;
                    const byAll = (G_SPONSORS||[]).find(s => s.id === prize.sponsor_id)?.name;
                    if (byAll) return byAll;
                  }
                  return prize.sponsor || prize.sponsor_name || "";
                })();

                return `
                  <tr>
                    <td>${place}${juniorBeatingAdult?' <span class="badge">Junior!</span>':''}</td>
                    <td>${escapeHtml(c.name)}</td>
                    ${showCat?`<td>${catBadge}</td>`:''}
                    <td>${metric}</td>
                    <td>${escapeHtml(prize.desc||"")}${prize.value?` ($${fmt(prize.value,0)})`:""}</td>
                    <td class="sponsor">${escapeHtml(sponsorLabel)}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;
      }
    }
  </script>

  <!-- ===================== ADMIN ======================== -->
  <script>
    function renderAdmin(root){
      const settings=G_SETTINGS;
      const branding=loadLocal(STORE_KEYS.branding, {logoDataUrl:null});
      const sponsors=loadLocal(STORE_KEYS.sponsors, {overall:[]}); // (kept for local export)

      root.innerHTML = `
        <section class="card">
          <h2>Admin</h2>
          <div class="grid two">
            <div>
              <h3>Event Settings</h3>
              <p class="sub">These fields mirror the DB where applicable. Fees & decimals are local-only for now.</p>
              <div class="row">
                <div class="col-6">
                  <label>Early-bird cutoff (DB)</label>
                  <div class="pad-around" style="border:0;box-shadow:none;background:transparent;padding:0">
                    <input id="s-cutoff" type="date" value="${settings.earlyBirdCutoff}" />
                  </div>
                </div>
                <div class="col-3"><label>Adult Early (local)</label><input id="s-ae" type="number" step="1" value="${settings.fees.Adult.early}"/></div>
                <div class="col-3"><label>Adult Standard (local)</label><input id="s-as" type="number" step="1" value="${settings.fees.Adult.standard}"/></div>
                <div class="col-3"><label>Junior Early (local)</label><input id="s-je" type="number" step="1" value="${settings.fees.Junior.early}"/></div>
                <div class="col-3"><label>Junior Standard (local)</label><input id="s-js" type="number" step="1" value="${settings.fees.Junior.standard}"/></div>
                <div class="col-3"><label>Decimals (local)</label><input id="s-dec" type="number" step="1" min="0" max="3" value="${settings.decimals}"/></div>
                <div class="col-3"><label>Comp Mode (DB)</label><select id="s-comp"><option ${settings.compMode==="weight"?"selected":""} value="weight">Weight</option><option ${settings.compMode==="measure"?"selected":""} value="measure">Measure (length)</option></select></div>
                <div class="col-3"><label>Show Time? (DB)</label><select id="s-showtime"><option ${settings.showTime?"selected":""} value="1">Yes</option><option ${!settings.showTime?"selected":""} value="0">No</option></select></div>
                <div class="col-3"><label>Require Time? (DB)</label><select id="s-reqtime"><option ${settings.requireTime?"selected":""} value="1">Yes</option><option ${!settings.requireTime?"selected":""} value="0">No</option></select></div>
                <div class="col-3"><label>Prize Mode (local)</label><select id="s-pmode"><option ${settings.prizeMode==="combined"?"selected":""} value="combined">Combined</option><option ${settings.prizeMode==="split"?"selected":""} value="split">Split Adult/Junior</option></select></div>
              </div>
              <div class="actions">
                <button class="btn primary" id="btn-save-settings">Save Settings</button>
              </div>
            </div>
            <div>
              <h3>Branding (local)</h3>
              <div class="grid">
                <div><label>Upload Logo (PNG/JPG)</label><input type="file" id="brand-file" accept="image/*"/></div>
                <div class="sub">Logo is stored locally in this browser for offline use.</div>
              </div>
              <hr style="border:none;border-top:1px solid var(--border);margin:12px 0"/>
              <h3>Event Sponsors</h3>
              <div class="sub">
                Competition: <strong>${escapeHtml(G_COMPETITION?.name || "— none —")}</strong>
                &nbsp;•&nbsp; Group: <strong>${escapeHtml(G_SPONSOR_GROUP?.name || "— none —")}</strong>
              </div>

              <div class="actions" style="margin-top:8px">
                <input id="sp-name" placeholder="Sponsor name (e.g., BP)" />
                <select id="sp-level">
                  ${G_SPONSOR_LEVELS.map(l => `<option value="${l.id}">${escapeHtml(l.label)}</option>`).join("")}
                </select>
                <input id="sp-order" type="number" min="1" step="1" placeholder="Order (opt)"/>
                <input id="sp-blurb" placeholder="Blurb / readout (opt)"/>
                <button class="btn" id="sp-add">Add</button>
              </div>

              <div id="sp-list" class="grid" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      `;

      // ---- Event Sponsors (render & wire) ----
      async function paintAssignments(){
        const list = $("#sp-list");
        const rows = G_COMP_SPONSORS;
        if (!rows.length){ list.innerHTML = `<div class="sub">No sponsors assigned yet.</div>`; return; }
        const groups = new Map();
        rows.forEach(r=>{
          const key = r.level?.label || "Partners";
          if(!groups.has(key)) groups.set(key, []);
          groups.get(key).push(r);
        });
        list.innerHTML = [...groups.entries()].map(([lvl, items]) => `
          <section class="card">
            <h4 style="margin:0 0 6px">${escapeHtml(lvl)}</h4>
            <div class="flex">
              ${items.map(it => `
                <span class="pill">
                  ${escapeHtml(it.sponsor?.name || "")}
                  <button class="btn danger" style="padding:4px 8px" data-id="${it.id}">remove</button>
                </span>
              `).join(" ")}
            </div>
          </section>
        `).join("");
        list.querySelectorAll("button[data-id]").forEach(btn=>{
          btn.onclick = async (e)=>{
            const id = e.currentTarget.getAttribute("data-id");
            if(!confirm("Remove sponsor?")) return;
            await sbDeleteCompetitionSponsor(id);
            G_COMP_SPONSORS = await sbListCompetitionSponsors(G_COMPETITION.id);
            paintAssignments();
          };
        });
      }
      paintAssignments();

      $("#sp-add").onclick = async ()=>{
        const name  = $("#sp-name").value.trim();
        const level = $("#sp-level").value;
        const order = $("#sp-order").value ? parseInt($("#sp-order").value,10) : null;
        const blurb = $("#sp-blurb").value.trim() || null;
        if(!name || !level || !G_COMPETITION){ alert("Missing sponsor, level or competition."); return; }
        await sbAddCompetitionSponsor({
          competition_id: G_COMPETITION.id,
          sponsor_name: name,
          level_id: level,
          display_order: order,
          blurb
        });
        $("#sp-name").value=""; $("#sp-order").value=""; $("#sp-blurb").value="";
        G_COMP_SPONSORS = await sbListCompetitionSponsors(G_COMPETITION.id);
        paintAssignments();
      };

      // ---- Settings & Branding handlers ----
      $("#btn-save-settings").onclick=async()=>{
        G_SETTINGS.fees.Adult.early=parseInt($("#s-ae").value||G_SETTINGS.fees.Adult.early);
        G_SETTINGS.fees.Adult.standard=parseInt($("#s-as").value||G_SETTINGS.fees.Adult.standard);
        G_SETTINGS.fees.Junior.early=parseInt($("#s-je").value||G_SETTINGS.fees.Junior.early);
        G_SETTINGS.fees.Junior.standard=parseInt($("#s-js").value||G_SETTINGS.fees.Junior.standard);
        G_SETTINGS.decimals=parseInt($("#s-dec").value||G_SETTINGS.decimals);
        G_SETTINGS.prizeMode=$("#s-pmode").value;

        const patch = {
          early_bird_cutoff: $("#s-cutoff").value || G_SETTINGS.earlyBirdCutoff,
          comp_mode: $("#s-comp").value,
          time_visible: $("#s-showtime").value==="1",
          time_required: $("#s-reqtime").value==="1",
          prize_mode: G_SETTINGS.prizeMode
        };
        const { data: row } = await sb.from('settings').select('id').limit(1).maybeSingle();
        if(row){ await sb.from('settings').update(patch).eq('id', row.id); }
        else{ await sb.from('settings').insert(patch); }

        G_SETTINGS = await sbFetchSettings();
        alert("Settings saved.");
      };

      $("#brand-file").addEventListener("change", (e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        const reader=new FileReader();
        reader.onload = (ev)=>{
          const dataUrl=ev.target.result;
          const b=loadLocal(STORE_KEYS.branding, {logoDataUrl:null});
          b.logoDataUrl=dataUrl; saveLocal(STORE_KEYS.branding, b);
          $("#brand-logo").src=dataUrl;
          alert("Logo updated.");
        };
        reader.readAsDataURL(f);
      });
    }
  </script>

  <!-- ============== IMPORT / EXPORT (local) ============= -->
  <script>
    function renderData(root){
      root.innerHTML = `
        <section class="card">
          <h2>Import / Export (local parts)</h2>
          <p class="sub">This exports/imports only local data: prizes, branding, sponsors. DB data (competitors/fish) stays in Supabase.</p>
          <div class="grid two">
            <div>
              <h3>Export Data</h3>
              <div class="actions">
                <button class="btn primary" id="btn-export">Export JSON</button>
              </div>
            </div>
            <div>
              <h3>Import Data</h3>
              <p class="sub">Upload a previously exported JSON file. This overwrites local data only.</p>
              <input type="file" id="imp-file" accept="application/json"/>
              <div class="actions">
                <button class="btn warn" id="btn-import">Import</button>
              </div>
            </div>
          </div>
          <hr style="border:none;border-top:1px solid var(--border);margin:12px 0"/>
          <h3>Danger Zone</h3>
          <div class="actions">
            <button class="btn danger" id="btn-clear-all">Clear LOCAL Data</button>
          </div>
        </section>
      `;
      $("#btn-export").onclick=()=>{
        const data={
          generatedAt:new Date().toISOString(),
          prizes:loadLocal(STORE_KEYS.prizes, {}),
          branding:loadLocal(STORE_KEYS.branding, {logoDataUrl:null}),
          sponsors:loadLocal(STORE_KEYS.sponsors, {overall:[]})
        };
        const blob=new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url; a.download="wosc-local-export-"+new Date().toISOString().slice(0,10)+".json";
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };
      $("#btn-import").onclick=()=>{
        const f=$("#imp-file").files?.[0]; if(!f){ alert("Choose a file first."); return; }
        if(!confirm("Importing will overwrite local data. Continue?")) return;
        const reader=new FileReader();
        reader.onload=(ev)=>{
          try{
            const data=JSON.parse(ev.target.result);
            if(data.prizes) saveLocal(STORE_KEYS.prizes,data.prizes);
            if(data.branding) saveLocal(STORE_KEYS.branding,data.branding);
            if(data.sponsors) saveLocal(STORE_KEYS.sponsors,data.sponsors);
            alert("Import completed.");
          }catch(err){ alert("Import failed: "+err.message); }
        };
        reader.readAsText(f);
      };
      $("#btn-clear-all").onclick=()=>{
        if(!confirm("Really clear local data (prizes/branding/sponsors)?")) return;
        [STORE_KEYS.prizes, STORE_KEYS.branding, STORE_KEYS.sponsors].forEach(k=>localStorage.removeItem(k));
        alert("Local data cleared.");
      };
    }
  </script>

  <!-- ======================= BOOT ======================= -->
  <script>
    function renderView(id){
      const el=$("#view");
      switch(id){
        case "register": return renderRegister(el);
        case "submit": return renderSubmit(el);
        case "results": return renderResults(el);
        case "prizes": return renderPrizes(el);
        case "prizegiving": return renderPrizeGiving(el);
        case "admin": return renderAdmin(el);
        case "data": return renderData(el);
        default: return renderRegister(el);
      }
    }
    async function boot(){
      await hydrateFromDB();
      const tab=(location.hash||"#register").slice(1);
      renderTabs(tab); renderView(tab);
    }
    window.addEventListener("hashchange", ()=>{
      const tab=(location.hash||"#register").slice(1);
      renderTabs(tab); renderView(tab);
    });
    document.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>
